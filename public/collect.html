<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Submit Your Ethereum Address</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container mobile-container">
        <div class="card">
            <h1>üîê Submit Your Address</h1>
            <p class="subtitle">Choose how you want to submit your Ethereum address</p>

            <div class="method-selector">
                <button class="method-btn active" onclick="switchMethod('wallet')" id="walletBtn">
                    <span class="method-icon">üëõ</span>
                    <span>Connect Wallet</span>
                </button>
                <button class="method-btn" onclick="switchMethod('manual')" id="manualBtn">
                    <span class="method-icon">‚å®Ô∏è</span>
                    <span>Enter Manually</span>
                </button>
            </div>

            <!-- Wallet Method -->
            <div id="walletMethod" class="method-content">
                <div id="notConnected" class="wallet-section">
                    <p class="info-text">Connect your Ethereum wallet to automatically fetch your addresses</p>
                    <button class="btn btn-primary btn-large" onclick="connectWallet()">
                        Connect Wallet
                    </button>
                    <p class="small-text">Supports MetaMask and WalletConnect</p>
                </div>

                <div id="connected" class="wallet-section" style="display: none;">
                    <div class="success-badge">
                        <span>‚úì Wallet Connected</span>
                    </div>

                    <div id="addressList" class="address-list"></div>

                    <div class="form-group">
                        <label for="walletNotes">Notes (optional)</label>
                        <input type="text" id="walletNotes" placeholder="e.g., Trading wallet, Cold storage, etc.">
                    </div>

                    <button class="btn btn-success btn-large" onclick="submitSelectedAddress()">
                        Submit Selected Address
                    </button>
                    <button class="btn btn-link" onclick="disconnectWallet()">
                        Disconnect Wallet
                    </button>
                </div>
            </div>

            <!-- Manual Method -->
            <div id="manualMethod" class="method-content" style="display: none;">
                <form id="manualForm" onsubmit="submitManualAddress(event)">
                    <div class="form-group">
                        <label for="manualAddress">Ethereum Address *</label>
                        <input
                            type="text"
                            id="manualAddress"
                            placeholder="0x..."
                            pattern="^0x[a-fA-F0-9]{40}$"
                            required
                        >
                        <small class="help-text">Must start with 0x followed by 40 hexadecimal characters</small>
                    </div>

                    <div class="form-group">
                        <label for="manualNotes">Notes (optional)</label>
                        <input type="text" id="manualNotes" placeholder="e.g., Trading wallet, Cold storage, etc.">
                    </div>

                    <button type="submit" class="btn btn-success btn-large">
                        Submit Address
                    </button>
                </form>
            </div>

            <!-- Status Messages -->
            <div id="statusMessage" class="status-message"></div>

            <div class="back-link">
                <a href="/">‚Üê Back to Home</a>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script>
        let provider = null;
        let selectedAddress = null;

        // Switch between wallet and manual methods
        function switchMethod(method) {
            const walletBtn = document.getElementById('walletBtn');
            const manualBtn = document.getElementById('manualBtn');
            const walletMethod = document.getElementById('walletMethod');
            const manualMethod = document.getElementById('manualMethod');

            if (method === 'wallet') {
                walletBtn.classList.add('active');
                manualBtn.classList.remove('active');
                walletMethod.style.display = 'block';
                manualMethod.style.display = 'none';
            } else {
                manualBtn.classList.add('active');
                walletBtn.classList.remove('active');
                manualMethod.style.display = 'block';
                walletMethod.style.display = 'none';
            }
            clearStatus();
        }

        // Connect to Web3 wallet
        async function connectWallet() {
            clearStatus();

            if (typeof window.ethereum === 'undefined') {
                showStatus('Please install MetaMask or another Web3 wallet', 'error');
                return;
            }

            try {
                provider = new ethers.providers.Web3Provider(window.ethereum);
                const accounts = await provider.send("eth_requestAccounts", []);

                if (accounts.length > 0) {
                    displayAddresses(accounts);
                    document.getElementById('notConnected').style.display = 'none';
                    document.getElementById('connected').style.display = 'block';
                }
            } catch (error) {
                console.error('Error connecting wallet:', error);
                showStatus('Failed to connect wallet: ' + error.message, 'error');
            }
        }

        // Display addresses for selection
        function displayAddresses(addresses) {
            const addressList = document.getElementById('addressList');
            addressList.innerHTML = '<p class="info-text">Select an address to submit:</p>';

            addresses.forEach((address, index) => {
                const div = document.createElement('div');
                div.className = 'address-item';
                div.innerHTML = `
                    <input type="radio" name="address" id="addr${index}" value="${address}" ${index === 0 ? 'checked' : ''}>
                    <label for="addr${index}">
                        <span class="address-text">${address}</span>
                    </label>
                `;
                addressList.appendChild(div);

                if (index === 0) {
                    selectedAddress = address;
                }
            });

            // Add change listener
            const radios = addressList.querySelectorAll('input[type="radio"]');
            radios.forEach(radio => {
                radio.addEventListener('change', (e) => {
                    selectedAddress = e.target.value;
                });
            });
        }

        // Submit selected address from wallet
        async function submitSelectedAddress() {
            if (!selectedAddress) {
                showStatus('Please select an address', 'error');
                return;
            }

            const notes = document.getElementById('walletNotes').value;
            await submitAddress(selectedAddress, notes);
        }

        // Submit manually entered address
        async function submitManualAddress(event) {
            event.preventDefault();
            const address = document.getElementById('manualAddress').value;
            const notes = document.getElementById('manualNotes').value;
            await submitAddress(address, notes);
        }

        // Submit address to backend
        async function submitAddress(address, notes) {
            clearStatus();

            try {
                const response = await fetch('/api/submit-address', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ address, notes })
                });

                const data = await response.json();

                if (data.success) {
                    showStatus('‚úì Address submitted successfully!', 'success');
                    // Reset forms
                    document.getElementById('manualForm').reset();
                    document.getElementById('walletNotes').value = '';
                } else {
                    showStatus('Error: ' + data.message, 'error');
                }
            } catch (error) {
                console.error('Error submitting address:', error);
                showStatus('Failed to submit address. Please try again.', 'error');
            }
        }

        // Disconnect wallet
        function disconnectWallet() {
            provider = null;
            selectedAddress = null;
            document.getElementById('notConnected').style.display = 'block';
            document.getElementById('connected').style.display = 'none';
            clearStatus();
        }

        // Show status message
        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = 'status-message ' + type;
            statusDiv.style.display = 'block';
        }

        // Clear status message
        function clearStatus() {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.style.display = 'none';
        }
    </script>
</body>
</html>
