<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Address Collector</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container admin-container">
        <div class="card">
            <div class="admin-header">
                <h1>üìä Admin Dashboard</h1>
                <button class="btn btn-secondary" onclick="refreshData()">üîÑ Refresh</button>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalCount">0</div>
                    <div class="stat-label">Total Addresses</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="todayCount">0</div>
                    <div class="stat-label">Added Today</div>
                </div>
            </div>

            <div class="admin-actions">
                <input type="text" id="searchInput" placeholder="üîç Search addresses..." onkeyup="filterAddresses()">
                <button class="btn btn-primary" onclick="exportToCSV()">üì• Export CSV</button>
            </div>

            <div class="table-container">
                <table class="address-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Address</th>
                            <th>Timestamp</th>
                            <th>Notes</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="addressTableBody">
                        <tr>
                            <td colspan="5" class="loading">Loading addresses...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div id="emptyState" class="empty-state" style="display: none;">
                <p>üì≠ No addresses collected yet</p>
                <a href="/collect" class="btn btn-primary">Go to Collection Form</a>
            </div>

            <div class="back-link">
                <a href="/">‚Üê Back to Home</a>
            </div>
        </div>
    </div>

    <script>
        let allAddresses = [];

        // Load addresses on page load
        window.addEventListener('DOMContentLoaded', () => {
            loadAddresses();
        });

        // Load all addresses from API
        async function loadAddresses() {
            try {
                const response = await fetch('/api/addresses');
                const data = await response.json();

                if (data.success) {
                    allAddresses = data.addresses;
                    displayAddresses(allAddresses);
                    updateStats(allAddresses);

                    if (allAddresses.length === 0) {
                        document.querySelector('.table-container').style.display = 'none';
                        document.getElementById('emptyState').style.display = 'block';
                    } else {
                        document.querySelector('.table-container').style.display = 'block';
                        document.getElementById('emptyState').style.display = 'none';
                    }
                } else {
                    showError('Failed to load addresses');
                }
            } catch (error) {
                console.error('Error loading addresses:', error);
                showError('Error loading addresses');
            }
        }

        // Display addresses in table
        function displayAddresses(addresses) {
            const tbody = document.getElementById('addressTableBody');

            if (addresses.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty-message">No addresses found</td></tr>';
                return;
            }

            tbody.innerHTML = addresses.map(addr => `
                <tr data-id="${addr.id}">
                    <td>${addr.id}</td>
                    <td class="address-cell">
                        <span class="address-text">${addr.address}</span>
                        <button class="btn-icon" onclick="copyToClipboard('${addr.address}')" title="Copy address">
                            üìã
                        </button>
                        <a href="https://etherscan.io/address/${addr.address}" target="_blank" class="btn-icon" title="View on Etherscan">
                            üîó
                        </a>
                    </td>
                    <td>${formatTimestamp(addr.timestamp)}</td>
                    <td>${addr.notes || '-'}</td>
                    <td>
                        <button class="btn btn-danger btn-small" onclick="deleteAddress(${addr.id})">
                            Delete
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Update statistics
        function updateStats(addresses) {
            document.getElementById('totalCount').textContent = addresses.length;

            // Count addresses added today
            const today = new Date().toDateString();
            const todayCount = addresses.filter(addr => {
                const addrDate = new Date(addr.timestamp).toDateString();
                return addrDate === today;
            }).length;
            document.getElementById('todayCount').textContent = todayCount;
        }

        // Format timestamp for display
        function formatTimestamp(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Copy address to clipboard
        async function copyToClipboard(address) {
            try {
                await navigator.clipboard.writeText(address);
                showToast('Address copied to clipboard!');
            } catch (error) {
                console.error('Failed to copy:', error);
                showToast('Failed to copy address', 'error');
            }
        }

        // Delete an address
        async function deleteAddress(id) {
            if (!confirm('Are you sure you want to delete this address?')) {
                return;
            }

            try {
                const response = await fetch(`/api/addresses/${id}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    showToast('Address deleted successfully');
                    loadAddresses(); // Reload the list
                } else {
                    showToast('Failed to delete address', 'error');
                }
            } catch (error) {
                console.error('Error deleting address:', error);
                showToast('Error deleting address', 'error');
            }
        }

        // Filter addresses based on search input
        function filterAddresses() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filteredAddresses = allAddresses.filter(addr =>
                addr.address.toLowerCase().includes(searchTerm) ||
                (addr.notes && addr.notes.toLowerCase().includes(searchTerm))
            );
            displayAddresses(filteredAddresses);
        }

        // Refresh data
        function refreshData() {
            loadAddresses();
            showToast('Data refreshed');
        }

        // Export to CSV
        function exportToCSV() {
            if (allAddresses.length === 0) {
                showToast('No data to export', 'error');
                return;
            }

            const headers = ['ID', 'Address', 'Timestamp', 'Notes'];
            const csvContent = [
                headers.join(','),
                ...allAddresses.map(addr => [
                    addr.id,
                    addr.address,
                    `"${addr.timestamp}"`,
                    `"${addr.notes || ''}"`
                ].join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ethereum-addresses-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            showToast('CSV exported successfully');
        }

        // Show toast notification
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.classList.add('show');
            }, 100);

            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }

        // Show error message
        function showError(message) {
            const tbody = document.getElementById('addressTableBody');
            tbody.innerHTML = `<tr><td colspan="5" class="error-message">${message}</td></tr>`;
        }
    </script>
</body>
</html>
